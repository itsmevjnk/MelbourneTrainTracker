<!DOCTYPE html>

<html>
    <head>
        <title>Melbourne Train Tracker</title>
        <style>
            body,html { width: 100%; height: 100%; margin: 0; }
            body { margin: 0 auto; }
            iframe { border: 0; }
            section { padding: 0.1rem 0; }
            #lines { display: grid; }
            @media (min-width: 768px) { body { max-width: 750px; } #lines { grid-template-columns: auto auto auto; } }
            @media (min-width: 992px) { body { max-width: 970px; } #lines { grid-template-columns: auto auto auto auto; } }
            @media (min-width: 1200px) { body { max-width: 1170px; } }
        </style>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <body>
        <h1>Melbourne Train Tracker</h1>
        <section>
            <h2>Settings</h2>
            <section>
                LED drivers: 
                <input type="radio" id="driver0" name="driver" value="0"/>
                <label for="driver0">Off</label>
                <input type="radio" id="driver1" name="driver" value="1"/>
                <label for="driver1">On</label>
            </section>
            <section>
                Lines:
                <button onclick="enableAll()">Enable all</button>
                <button onclick="disableAll()">Disable all</button>
                <div id="lines"></div>
            </section>
        </section>
        <section>
            <h2>LED Buffer View</h2>
            <iframe src="board.htm" width="100%" scrolling="no" id="bview"></iframe>
        </section>
        <script>
            const host = window.location.hostname;
            const lines = {
                SHM: "Sandringham",
                MDD: "Mernda",
                HBE: "Hurstbridge",
                CCL: "City Circle",
                PKM: "Pakenham",
                CBE: "Cranbourne",
                BEG: "Belgrave",
                LIL: "Lilydale",
                GWY: "Glen Waverley",
                ALM: "Alamein",
                STY: "Stony Point",
                FKN: "Frankston",
                WIL: "Williamstown",
                WER: "Werribee",
                CGB: "Craigieburn",
                SUY: "Sunbury",
                RCE: "Flemington Racecourse",
                UFD: "Upfield",
                ART: "Ararat via Melton",
                BAT: "Ballarat via Melton",
                MBY: "Maryborough via Melton",
                BDE: "Bairnsdale via Pakenham",
                TRN: "Traralgon via Pakenham",
                vPK: "Pakenham (V/Line)",
                GEL: "Geelong via Wyndham Vale",
                WBL: "Warrnambool via Wyndham Vale"
            };
            const lineBoxes = document.getElementById('lines');
            const enableLine = (line) => fetch(`http://${host}/lines?l=${line}`, {method: 'PUT'});
            const disableLine = (line) => fetch(`http://${host}/lines?l=${line}`, {method: 'DELETE'});
            for (const [key, value] of Object.entries(lines)) {
                const id = `line_${key}`;
                lineBoxes.innerHTML += `<div><input type="checkbox" id="${id}" name="${id}" /><label for="${id}">${value}</label></div>`;
            }
            const board = document.getElementById('bview');
            const updateBoardHeight = () => {
                board.setAttribute('height', board.clientWidth / 423.5 * 402.4 + 'px');
            };
            window.addEventListener('load', updateBoardHeight);
            window.addEventListener('resize', updateBoardHeight);
            window.addEventListener('load', () => {
                fetch(`http://${host}/driver`).then((resp) => resp.text()).then((data) => document.getElementById('driver'+data).checked = true);
                fetch(`http://${host}/lines`).then((resp) => resp.text()).then((data) => {
                    data = data.split(',');
                    for (const [key, value] of Object.entries(lines)) {
                        const id = `line_${key}`;
                        const elem = document.getElementById(id);
                        if (data.includes(key)) elem.checked = true;
                        elem.addEventListener('change', (event) => {
                            if (event.currentTarget.checked) enableLine(key);
                            else disableLine(key);
                        });
                    }
                });
            });
            const enableAll = () => enableLine('all').then(() => {
                for (const key of Object.keys(lines))
                    document.getElementById(`line_${key}`).checked = true;
            });
            const disableAll = () => disableLine('all').then(() => {
                for (const key of Object.keys(lines))
                    document.getElementById(`line_${key}`).checked = false;
            });
            for (let i = 0; i < 2; i++) document.getElementById(`driver${i}`).addEventListener('change', () => fetch(`http://${host}/driver?s=${i}`, {method: 'POST'}));
        </script>
    </body>
</html>